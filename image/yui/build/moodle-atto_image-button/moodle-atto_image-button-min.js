YUI.add("moodle-atto_image-button",function(d,e){var c={RESPONSIVE:"img-responsive",INPUTALIGNMENT:"atto_image_alignment",INPUTALT:"atto_image_altentry",INPUTHEIGHT:"atto_image_heightentry",INPUTSUBMIT:"atto_image_urlentrysubmit",INPUTURL:"atto_image_urlentry",INPUTSIZE:"atto_image_size",INPUTWIDTH:"atto_image_widthentry",IMAGEALTWARNING:"atto_image_altwarning",IMAGEBROWSER:"openimagebrowser",IMAGEPRESENTATION:"atto_image_presentation",INPUTCONSTRAIN:"atto_image_constrain",INPUTCUSTOMSTYLE:"atto_image_customstyle",IMAGEPREVIEW:"atto_image_preview",IMAGEPREVIEWBOX:"atto_image_preview_box",ALIGNSETTINGS:"atto_image_button"},t={INPUTURL:"."+c.INPUTURL},o=[{name:"verticalAlign",str:"alignment_top",value:"text-top",margin:"0 0.5em"},{name:"verticalAlign",str:"alignment_middle",value:"middle",margin:"0 0.5em"},{name:"verticalAlign",str:"alignment_bottom",value:"text-bottom",margin:"0 0.5em",isDefault:!0},{name:"float",str:"alignment_left",value:"left",margin:"0 0.5em 0 0"},{name:"float",str:"alignment_right",value:"right",margin:"0 0 0 0.5em"}],p="atto_image",h='<img src="{{url}}" alt="{{alt}}" {{#if presentation}}role="presentation" {{/if}}{{#if customstyle}}style="{{customstyle}}" {{/if}}{{#if classlist}}class="attoimage {{classlist}}" {{/if}}{{#if id}}id="{{id}}" {{/if}}/>';d.namespace("M.atto_image").Button=d.Base.create("button",d.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_selectedImage:null,_form:null,_rawImageDimensions:null,initializer:function(){this.addButton({icon:"e/insert_edit_image",callback:this._displayDialogue,tags:".attoimage",tagMatchRequiresAll:!1}),this.editor.delegate("dblclick",this._displayDialogue,".attoimage",this),this.editor.delegate("click",this._handleClick,".attoimage",this),this.editor.on("drop",this._handleDragDrop,this),this.editor.on("dragover",function(e){e.preventDefault()},this),this.editor.on("dragenter",function(e){e.preventDefault()},this)},_handleDragDrop:function(e){var t,i,n,a,o,s,l,r,g,c=this,u=this.get("host"),m=d.Handlebars.compile(h);if(u.saveSelection(),(e=e._event).dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length&&/^image\//.test(e.dataTransfer.files[0].type)){for(i=(t=u.get("filepickeroptions").image).savepath===undefined?"/":t.savepath,n=new FormData,a=0,o="",s=new XMLHttpRequest,l="",r=Object.keys(t.repositories),e.preventDefault(),e.stopPropagation(),n.append("repo_upload_file",e.dataTransfer.files[0]),n.append("itemid",t.itemid),g=0;g<r.length;g++)if("upload"===t.repositories[r[g]].type){n.append("repo_id",t.repositories[r[g]].id);break}return n.append("env",t.env),n.append("sesskey",M.cfg.sesskey),n.append("client_id",t.client_id),n.append("savepath",i),n.append("ctx_id",t.context.id),a=(new Date).getTime(),o="moodleimage_"+Math.round(1e5*Math.random())+"-"+a,u.focus(),u.restoreSelection(),l=m({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading",p),id:o}),u.insertContentAtFocusPoint(l),c.markUpdated(),s.onreadystatechange=function(){var e,t,i,n,a=c.editor.one("#"+o);if(4===s.readyState)if(200===s.status){if(e=JSON.parse(s.responseText)){if(e.error)return a&&a.remove(!0),new M.core.ajaxException(e);(t=e).event&&"fileexists"===e.event&&(t=e.newfile),i=m({url:t.url,presentation:!0}),n=d.Node.create(i),a?a.replace(n):c.editor.appendChild(n),c.markUpdated()}}else d.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("servererror","moodle")})}),a&&a.remove(!0)},s.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),s.send(n),!1}},_handleClick:function(e){var t=e.target,i=this.get("host").getSelectionFromNode(t);this.get("host").getSelection()!==i&&this.get("host").setSelection(i)},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection(),!1!==this._currentSelection&&(this._rawImageDimensions=null,this.getDialogue({headerContent:M.util.get_string("imageproperties",p),width:"auto",focusAfterHide:!0,focusOnShowSelector:t.INPUTURL}).set("bodyContent",this._getDialogueContent()).show())},_loadPreviewImage:function(e){var t=new Image,i=this;t.onerror=function(){i._form.one("."+c.IMAGEPREVIEW).setStyles({display:"none"}),i.getDialogue().centerDialogue()},t.onload=function(){input=i._form.one("."+c.IMAGEPREVIEW),input.setAttribute("src",this.src),input.setStyles({display:"inline"}),i.getDialogue().centerDialogue()},t.src=e},_getDialogueContent:function(){var e=d.Handlebars.compile(
'<form class="atto_form">{{#if showFilepicker}}<div class="mb-1"><label for="{{elementid}}_{{CSS.INPUTURL}}">{{get_string "enterurl" component}}</label><div class="input-group input-append w-100"><input class="form-control {{CSS.INPUTURL}}" type="url" id="{{elementid}}_{{CSS.INPUTURL}}" size="32"/><span class="input-group-append"><button class="btn btn-secondary {{CSS.IMAGEBROWSER}}" type="button">{{get_string "browserepositories" component}}</button></span></div></div>{{else}}<div class="mb-1"><label for="{{elementid}}_{{CSS.INPUTURL}}">{{get_string "enterurl" component}}</label><input class="form-control fullwidth {{CSS.INPUTURL}}" type="url" id="{{elementid}}_{{CSS.INPUTURL}}" size="32"/></div>{{/if}}<div style="display:none" role="alert" class="alert alert-warning mb-1 {{CSS.IMAGEALTWARNING}}">{{get_string "presentationoraltrequired" component}}</div><div class="mb-1"><label for="{{elementid}}_{{CSS.INPUTALT}}">{{get_string "enteralt" component}}</label><input class="form-control fullwidth {{CSS.INPUTALT}}" type="text" value="" id="{{elementid}}_{{CSS.INPUTALT}}" size="32"/><div class="form-check"><input type="checkbox" class="form-check-input {{CSS.IMAGEPRESENTATION}}" id="{{elementid}}_{{CSS.IMAGEPRESENTATION}}"/><label class="form-check-label" for="{{elementid}}_{{CSS.IMAGEPRESENTATION}}">{{get_string "presentation" component}}</label></div></div><div class="form-inline mb-1"><label class="for="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{get_string "alignment" component}}</label><select class="custom-select {{CSS.INPUTALIGNMENT}}" id="{{elementid}}_{{CSS.INPUTALIGNMENT}}">{{#each alignments}}<option value="{{value}}">{{get_string str ../component}}</option>{{/each}}</select></div><input type="hidden" class="{{CSS.INPUTCUSTOMSTYLE}}"/><br/><div class="mdl-align"><div class="{{CSS.IMAGEPREVIEWBOX}}"><img src="#" class="{{CSS.IMAGEPREVIEW}}" alt="" style="display: none;"/></div><button class="btn btn-secondary {{CSS.INPUTSUBMIT}}" type="submit">{{get_string "saveimage" component}}</button></div></form>'),t=this.get("host").canShowFilepicker("image"),i=d.Node.create(e({elementid:this.get("host").get("elementid"),CSS:c,component:p,showFilepicker:t,alignments:o}));return this._form=i,console.log("init form",this._form),this._applyImageProperties(this._form),this._form.one("."+c.INPUTURL).on("blur",this._urlChanged,this),this._form.one("."+c.IMAGEPRESENTATION).on("change",this._updateWarning,this),this._form.one("."+c.INPUTALT).on("change",this._updateWarning,this),this._form.one("."+c.INPUTURL).on("blur",this._urlChanged,this),this._form.one("."+c.INPUTSUBMIT).on("click",this._setImage,this),t&&i.delegate("click",function(e){var t=this._form;e.preventDefault(),this.get("host").showFilepicker("image",this._getFilepickerCallback(t),this)},".openimagebrowser",this),i},_filepickerCallback:function(e){""!==e.url&&(this._form.one("."+c.INPUTURL).set("value",e.url),this._loadPreviewImage(e.url))},_getFilepickerCallback:function(i){return console.log("element",i),function(e){var t;""!==e.url&&(i.one("."+c.INPUTURL).set("value",e.url),(t=new Image).onerror=function(){i.one("."+c.IMAGEPREVIEW).setStyles({display:"none"})},t.onload=function(){var e;(e=i.one("."+c.IMAGEPREVIEW)).setAttribute("src",this.src),e.setStyles({display:"inline"})},t.src=e.url)}},_applyImageProperties:function(t){var e=this._getSelectedImageProperties(),i=t.one("."+c.IMAGEPREVIEW);if(!1===e)return i.setStyle("display","none"),void o.some(function(e){return!!e.isDefault&&(t.one("."+c.INPUTALIGNMENT).set("value",e.value),!0)},this);e.align&&t.one("."+c.INPUTALIGNMENT).set("value",e.align),e.customstyle&&t.one("."+c.INPUTCUSTOMSTYLE).set("value",e.customstyle),e.alt&&t.one("."+c.INPUTALT).set("value",e.alt),e.src&&(t.one("."+c.INPUTURL).set("value",e.src),this._loadPreviewImage(e.src)),e.presentation&&t.one("."+c.IMAGEPRESENTATION).set("checked","checked")},_getSelectedImageProperties:function(){var e,t,i={src:null,alt:null,align:"",presentation:!1},n=this.get("host").getSelectedNodes();return(n=n&&n.filter("img"))&&n.size()?(t=this._removeLegacyAlignment(n.item(0)),e=(this._selectedImage=t).getAttribute("style"),i.customstyle=e,this._getAlignmentPropeties(t,i),i.src=t.getAttribute("src"),i.alt=t.getAttribute("alt")||"",i.presentation="presentation"===t.get("role"),i):(this._selectedImage=null,!1)},_getAlignmentPropeties:function(i,n){var a;!o.some(function(e){var t=this._getAlignmentClass(e.value);return i.hasClass(t)?(n.align=e.value,!0):(e.isDefault&&(a=e.value),!1)},this)&&a&&(n.align=a)},_urlChanged:function(){var e=this._form.one("."+c.INPUTURL);""!==e.get("value")&&this._loadPreviewImage(e.get("value"))},_setImage:function(e){var t,i=this._form,n=i.one("."+c.INPUTURL).get("value"),a=i.one("."+c.INPUTALT).get("value"),o=this._getAlignmentClass(i.one("."+c.INPUTALIGNMENT).get("value")),s=i.one("."+c.IMAGEPRESENTATION).get("checked"),l=i.one("."+c.INPUTCUSTOMSTYLE).get("value"),r=[],g=this.get("host");e.preventDefault(),this._updateWarning()||(g.focus(),""!==n&&(this._selectedImage?g.setSelection(g.getSelectionFromNode(this._selectedImage)):g.setSelection(this._currentSelection),r.push(o),t=d.Handlebars.compile(h)({url:n,alt:a,presentation:s,customstyle:l,classlist:r.join(" ")}),this.get("host").insertContentAtFocusPoint(t),this.markUpdated()),this.getDialogue({focusAfterHide:null}).hide())},_removeLegacyAlignment:function(i){return i.getStyle("margin")&&o.some(function(e){if(i.getStyle(e.name)!==e.value)return!1;var t=d.Node.create("<div>");return t.setStyle("margin",e.margin),i.getStyle("margin")===t.getStyle("margin")&&(i.addClass(this._getAlignmentClass(e.value)),i.setStyle(e.name,null),i.setStyle("margin",null),!0)},this),i},_getAlignmentClass:function(e){return c.ALIGNSETTINGS+"_"+e},_updateWarning:function(){var e=this._form,t=!0,i=e.one("."+c.INPUTALT).get("value"),n=e.one("."+c.IMAGEPRESENTATION).get("checked");return t=""!==i||n?(e.one("."+c.IMAGEALTWARNING).setStyle("display","none"),e.one("."+c.INPUTALT
).setAttribute("aria-invalid",!1),e.one("."+c.IMAGEPRESENTATION).setAttribute("aria-invalid",!1),!1):(e.one("."+c.IMAGEALTWARNING).setStyle("display","block"),e.one("."+c.INPUTALT).setAttribute("aria-invalid",!0),e.one("."+c.IMAGEPRESENTATION).setAttribute("aria-invalid",!0),!0),this.getDialogue().centerDialogue(),t}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});